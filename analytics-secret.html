<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JetLagPro Analytics Dashboard</title>
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="JetLagPro Research Data Analytics">
    <script src="load-common-head.js?v=20250912224615"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <script>
        // Global variables for data
        let surveyData = [];
        let isLoading = true;

        // Firebase REST API endpoint (same as iOS app)
        const FIREBASE_REST_URL = "https://firestore.googleapis.com/v1/projects/jetlagpro-research/databases/(default)/documents/tripCompletions";

        // Initialize function (no Firebase SDK needed)
        async function initializeDashboard() {
            try {
                console.log('üöÄ Starting dashboard initialization...');
                console.log('üì° Using Firebase REST API endpoint:', FIREBASE_REST_URL);
                
                // Start loading dashboard data
                console.log('üöÄ Analytics Dashboard initializing...');
                await loadDashboardData();
                
                console.log('‚úÖ Dashboard initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Dashboard initialization failed:', error);
                showError('Failed to initialize dashboard: ' + error.message);
            }
        }

        // Load all dashboard data
        async function loadDashboardData() {
            try {
                isLoading = true;
                showLoadingState();
                
                console.log('üìä Loading survey data from Firebase REST API...');
                await loadSurveyData();
                
                console.log('üìä Rendering dashboard...');
                renderDashboard();
                
                isLoading = false;
                console.log('‚úÖ Dashboard loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Error loading dashboard:', error);
                showError('Failed to load dashboard data: ' + error.message);
                isLoading = false;
            }
        }

        // Load survey data from Firebase REST API (same approach as iOS app)
        async function loadSurveyData() {
            try {
                console.log('üîç Querying Firebase REST API...');
                console.log('URL:', FIREBASE_REST_URL);
                
                const response = await fetch(FIREBASE_REST_URL, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Raw response:', data);
                
                // Parse the response the same way the iOS app does
                if (data.documents && Array.isArray(data.documents)) {
                    console.log(`üìù Found ${data.documents.length} total documents`);
                    
                    surveyData = [];
                    data.documents.forEach((document, index) => {
                        if (document.fields) {
                            // Convert Firestore document format to flat structure
                            const flatData = convertFirestoreDocument(document);
                            if (flatData) {
                                surveyData.push(flatData);
                                console.log(`üìù Document ${index + 1}:`, flatData);
                            }
                        }
                    });
                    
                    console.log(`üìù Loaded ${surveyData.length} survey records`);
                } else {
                    console.warn('‚ö†Ô∏è No documents found in response');
                    surveyData = [];
                }
                
            } catch (error) {
                console.error('‚ùå Error loading survey data:', error);
                throw new Error('Failed to load trip completion data from Firebase REST API: ' + error.message);
            }
        }

        // Convert Firestore document format to flat structure (handles both old nested and new flattened formats)
        function convertFirestoreDocument(document) {
            try {
                const fields = document.fields;
                if (!fields) return null;
                
                // Helper function to extract nested values (for old format)
                const extractNestedValue = (fieldName, nestedPath = null) => {
                    const field = fields[fieldName];
                    if (!field) return null;
                    
                    // Handle nested objects (old format)
                    if (nestedPath && field.mapValue && field.mapValue.fields) {
                        const nestedField = field.mapValue.fields[nestedPath];
                        if (nestedField) {
                            if (nestedField.stringValue) return nestedField.stringValue;
                            if (nestedField.integerValue) return parseInt(nestedField.integerValue);
                            if (nestedField.booleanValue !== undefined) return nestedField.booleanValue;
                            if (nestedField.timestampValue) return new Date(nestedField.timestampValue);
                        }
                        return null;
                    }
                    
                    // Handle direct values (new format)
                    if (field.stringValue) return field.stringValue;
                    if (field.integerValue) return parseInt(field.integerValue);
                    if (field.booleanValue !== undefined) return field.booleanValue;
                    if (field.timestampValue) return new Date(field.timestampValue);
                    
                    return null;
                };
                
                // Extract values from Firestore format (handles both formats)
                const extractString = (fieldName, nestedPath = null) => {
                    return extractNestedValue(fieldName, nestedPath);
                };
                
                const extractInteger = (fieldName, nestedPath = null) => {
                    return extractNestedValue(fieldName, nestedPath);
                };
                
                const extractBoolean = (fieldName, nestedPath = null) => {
                    return extractNestedValue(fieldName, nestedPath);
                };
                
                const extractTimestamp = (fieldName, nestedPath = null) => {
                    return extractNestedValue(fieldName, nestedPath);
                };
                
                // Convert to flat structure matching the iOS app data format
                // Try new format first, then fall back to old nested format
                const flatData = {
                    id: document.name ? document.name.split('/').pop() : null,
                    surveyCode: extractString('surveyCode') || extractString('tripData', 'surveyCode'),
                    tripId: extractString('tripId') || extractString('tripData', 'tripId'),
                    platform: extractString('platform') || extractString('tripData', 'platform'),
                    appVersion: extractString('appVersion') || extractString('tripData', 'appVersion'),
                    destinationCode: extractString('destinationCode') || extractString('tripData', 'destinationCode'),
                    timezonesCount: extractInteger('timezonesCount') || extractInteger('tripData', 'timezonesCount'),
                    travelDirection: extractString('travelDirection') || extractString('tripData', 'travelDirection'),
                    pointsCompleted: extractInteger('pointsCompleted') || extractInteger('tripData', 'pointsCompleted'),
                    startDate: extractTimestamp('startDate') || extractTimestamp('tripData', 'startDate'),
                    completionDate: extractTimestamp('completionDate') || extractTimestamp('tripData', 'completionDate'),
                    completionMethod: extractString('completionMethod') || extractString('tripData', 'completionMethod'),
                    surveyCompleted: extractBoolean('surveyCompleted') || extractBoolean('surveyData', 'surveyCompleted'),
                    created: extractTimestamp('created') || extractTimestamp('tripData', 'created'),
                    
                    // Extract individual point completion status
                    point1Completed: extractBoolean('point1Completed'),
                    point2Completed: extractBoolean('point2Completed'),
                    point3Completed: extractBoolean('point3Completed'),
                    point4Completed: extractBoolean('point4Completed'),
                    point5Completed: extractBoolean('point5Completed'),
                    point6Completed: extractBoolean('point6Completed'),
                    point7Completed: extractBoolean('point7Completed'),
                    point8Completed: extractBoolean('point8Completed'),
                    point9Completed: extractBoolean('point9Completed'),
                    point10Completed: extractBoolean('point10Completed'),
                    point11Completed: extractBoolean('point11Completed'),
                    point12Completed: extractBoolean('point12Completed'),
                    
                    // Extract survey symptom data (baseline/typical symptoms) - handles both formats
                    baselineSleep: extractInteger('sleepPre') || extractInteger('surveyData', 'sleepPre'),
                    baselineFatigue: extractInteger('fatiguePre') || extractInteger('surveyData', 'fatiguePre'),
                    baselineConcentration: extractInteger('concentrationPre') || extractInteger('surveyData', 'concentrationPre'),
                    baselineIrritability: extractInteger('irritabilityPre') || extractInteger('surveyData', 'irritabilityPre'),
                    baselineGI: extractInteger('giPre') || extractInteger('surveyData', 'giPre'),
                    
                    // Extract anticipated symptoms - handles both formats
                    anticipatedSleepSeverity: extractInteger('sleepExpectations') || extractInteger('surveyData', 'sleepExpectations'),
                    anticipatedFatigueSeverity: extractInteger('fatigueExpectations') || extractInteger('surveyData', 'fatigueExpectations'),
                    anticipatedConcentrationSeverity: extractInteger('concentrationExpectations') || extractInteger('surveyData', 'concentrationExpectations'),
                    anticipatedIrritabilitySeverity: extractInteger('irritabilityExpectations') || extractInteger('surveyData', 'irritabilityExpectations'),
                    anticipatedGISeverity: extractInteger('giExpectations') || extractInteger('surveyData', 'giExpectations'),
                    
                    // Extract post-travel symptoms - handles both formats
                    postSleepSeverity: extractInteger('sleepPost') || extractInteger('surveyData', 'sleepPost'),
                    postFatigueSeverity: extractInteger('fatiguePost') || extractInteger('surveyData', 'fatiguePost'),
                    postConcentrationSeverity: extractInteger('concentrationPost') || extractInteger('surveyData', 'concentrationPost'),
                    postIrritabilitySeverity: extractInteger('irritabilityPost') || extractInteger('surveyData', 'irritabilityPost'),
                    postGISeverity: extractInteger('giPost') || extractInteger('surveyData', 'giPost'),
                    
                    // For compatibility with existing dashboard logic - handles both formats
                    timestamp: extractTimestamp('completionDate') || extractTimestamp('created') || extractTimestamp('tripData', 'completionDate'),
                    timezones_count: extractInteger('timezonesCount') || extractInteger('tripData', 'timezonesCount'),
                    travel_direction: extractString('travelDirection') || extractString('tripData', 'travelDirection'),
                    surveyCode: extractString('surveyCode') || extractString('tripData', 'surveyCode')
                };
                
                return flatData;
                
            } catch (error) {
                console.error('‚ùå Error converting document:', error);
                return null;
            }
        }

        // Calculate key statistics (now handled in renderSymptomAnalysis)
        function calculateStatistics() {
            // Statistics are now calculated and displayed directly in renderSymptomAnalysis
            // This function is kept for compatibility but no longer updates DOM elements
        }

        // Render dashboard sections
        function renderDashboard() {
            renderSymptomAnalysis();
            renderStimulationEfficacy();
            renderAdvancedAnalytics();
            renderRecentSubmissions();
        }

        // Render stimulation efficacy analysis
        function renderStimulationEfficacy() {
            const container = document.getElementById('stimulationEfficacy');
            
            if (surveyData.length === 0) {
                container.innerHTML = '<div class="error">No survey data available</div>';
                return;
            }
            
            // Filter to only include completed surveys (ignore app exploration/testing)
            const completedSurveys = surveyData.filter(survey => survey.surveyCompleted === true);
            
            if (completedSurveys.length === 0) {
                container.innerHTML = '<div class="error">No completed surveys available for analysis</div>';
                return;
            }
            
            console.log(`üìä Analyzing ${completedSurveys.length} completed surveys out of ${surveyData.length} total records`);
            
            // Debug: Log sample survey data to see actual values
            if (completedSurveys.length > 0) {
                console.log('üîç Sample completed survey data:', completedSurveys[0]);
                console.log('üîç Sleep data sample:', {
                    baseline: completedSurveys[0].baselineSleep,
                    anticipated: completedSurveys[0].anticipatedSleepSeverity,
                    post: completedSurveys[0].postSleepSeverity
                });
            }
            

            // Group data by stimulation level
            const stimulationGroups = {
                '0 points': [],
                '1-3 points': [],
                '4-6 points': [],
                '7-9 points': [],
                '10-12 points': []
            };

            completedSurveys.forEach(survey => {
                const points = survey.pointsCompleted || 0;
                if (points === 0) stimulationGroups['0 points'].push(survey);
                else if (points <= 3) stimulationGroups['1-3 points'].push(survey);
                else if (points <= 6) stimulationGroups['4-6 points'].push(survey);
                else if (points <= 9) stimulationGroups['7-9 points'].push(survey);
                else stimulationGroups['10-12 points'].push(survey);
            });

            let html = '<div style="margin-bottom: 30px;">';
            html += '<h3>Time Zone Effect vs. Stimulation Analysis</h3>';                                                                       
            html += '<p>Primary analysis: How acupressure stimulation reduces the expected increase in post-travel symptoms from crossing more time zones</p>';                                            
            html += '</div>';

            // Create efficacy table
            html += '<table class="data-table"><thead><tr><th>Stimulation Level</th><th>Sample Size</th><th>Avg Post-Travel Severity</th><th>Avg Time Zones Crossed</th><th>Protection Effect*</th></tr></thead><tbody>';

            Object.entries(stimulationGroups).forEach(([group, surveys]) => {
                if (surveys.length === 0) return;

                // Calculate post-travel severity and protection effect
                let totalPostTravelSeverity = 0;
                let totalTimeZones = 0;
                let validCount = 0;
                const timezones = [];

                surveys.forEach(survey => {
                    // Focus on post-travel symptom severity (primary outcome)
                    if (survey.postSleepSeverity !== null) {
                        totalPostTravelSeverity += survey.postSleepSeverity;
                        validCount++;
                    }
                    
                    // Track time zones crossed
                    if (survey.timezonesCount) {
                        totalTimeZones += survey.timezonesCount;
                        timezones.push(survey.timezonesCount);
                    }
                });

                const avgPostTravelSeverity = validCount > 0 ? (totalPostTravelSeverity / validCount).toFixed(2) : 'N/A';
                const avgTimeZones = timezones.length > 0 ? (totalTimeZones / timezones.length).toFixed(1) : 'N/A';
                
                // Calculate protection effect (lower severity relative to time zones crossed)
                const protectionEffect = validCount > 0 && timezones.length > 0 && avgTimeZones > 0 ? 
                    (avgPostTravelSeverity / avgTimeZones).toFixed(3) : 'N/A';

                html += `<tr>
                    <td><strong>${group}</strong></td>
                    <td>${surveys.length}</td>
                    <td style="color: ${avgPostTravelSeverity < 3 ? '#16a34a' : avgPostTravelSeverity < 4 ? '#eab308' : '#dc2626'}">${avgPostTravelSeverity}</td>                     
                    <td>${avgTimeZones}</td>                     
                    <td style="color: ${protectionEffect < 0.5 ? '#16a34a' : protectionEffect < 0.7 ? '#eab308' : '#dc2626'}">${protectionEffect}</td>
                </tr>`;
            });

            html += '</tbody></table>';

            // Add Time Zone Analysis
            html += '<h3 style="margin-top: 40px; margin-bottom: 20px;">Primary Analysis: Time Zone ‚Üí Symptom Relationship</h3>';                                        
            html += '<p>Core research question: Does acupressure stimulation reduce the expected increase in post-travel symptoms from crossing more time zones?</p>';
            
            // Group by time zone ranges
            const tzGroups = {
                '1-3 time zones': [],
                '4-6 time zones': [],
                '7-9 time zones': [],
                '10+ time zones': []
            };

            completedSurveys.forEach(survey => {
                const tz = survey.timezonesCount || 0;
                if (tz <= 3) tzGroups['1-3 time zones'].push(survey);
                else if (tz <= 6) tzGroups['4-6 time zones'].push(survey);
                else if (tz <= 9) tzGroups['7-9 time zones'].push(survey);
                else tzGroups['10+ time zones'].push(survey);
            });

            html += '<table class="data-table"><thead><tr><th>Time Zone Range</th><th>Sample Size</th><th>Avg Stimulation Points</th><th>Avg Sleep Improvement</th><th>Avg Post-Travel Severity</th></tr></thead><tbody>';

            Object.entries(tzGroups).forEach(([range, surveys]) => {
                if (surveys.length === 0) return;

                const avgPoints = (surveys.reduce((sum, s) => sum + (s.pointsCompleted || 0), 0) / surveys.length).toFixed(1);
                
                // Calculate sleep improvements
                const validSleepSurveys = surveys.filter(s => s.baselineSleep !== null && s.postSleepSeverity !== null);
                let avgSleepImprovement = 'N/A';
                let avgPostSeverity = 'N/A';

                if (validSleepSurveys.length > 0) {
                    avgSleepImprovement = (validSleepSurveys.reduce((sum, s) => sum + (s.baselineSleep - s.postSleepSeverity), 0) / validSleepSurveys.length).toFixed(2);
                    avgPostSeverity = (validSleepSurveys.reduce((sum, s) => sum + s.postSleepSeverity, 0) / validSleepSurveys.length).toFixed(2);
                }

                html += `<tr>
                    <td><strong>${range}</strong></td>
                    <td>${surveys.length}</td>
                    <td>${avgPoints}</td>
                    <td style="color: ${avgSleepImprovement > 0 ? '#16a34a' : '#dc2626'}">${avgSleepImprovement}</td>
                    <td>${avgPostSeverity}</td>
                </tr>`;
            });

            html += '</tbody></table>';

            // Add Travel Direction Analysis
            html += '<h3 style="margin-top: 40px; margin-bottom: 20px;">Travel Direction Analysis</h3>';
            html += '<p>Eastward vs Westward travel effects on jet lag and stimulation effectiveness</p>';
            
            const eastwardSurveys = completedSurveys.filter(s => s.travelDirection === 'Eastward');
            const westwardSurveys = completedSurveys.filter(s => s.travelDirection === 'Westward');

            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">';
            
            // Eastward analysis
            html += '<div><h4>üåÖ Eastward Travel (More Severe Jet Lag)</h4>';
            if (eastwardSurveys.length > 0) {
                const avgPointsEast = (eastwardSurveys.reduce((sum, s) => sum + (s.pointsCompleted || 0), 0) / eastwardSurveys.length).toFixed(1);
                const avgTzEast = (eastwardSurveys.reduce((sum, s) => sum + (s.timezonesCount || 0), 0) / eastwardSurveys.length).toFixed(1);
                
                const validEastSleep = eastwardSurveys.filter(s => s.baselineSleep !== null && s.postSleepSeverity !== null);
                let avgImprovementEast = 'N/A';
                if (validEastSleep.length > 0) {
                    avgImprovementEast = (validEastSleep.reduce((sum, s) => sum + (s.baselineSleep - s.postSleepSeverity), 0) / validEastSleep.length).toFixed(2);
                }

                html += `<table class="data-table"><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody>`;
                html += `<tr><td>Sample Size</td><td>${eastwardSurveys.length}</td></tr>`;
                html += `<tr><td>Avg Stimulation Points</td><td>${avgPointsEast}</td></tr>`;
                html += `<tr><td>Avg Time Zones</td><td>${avgTzEast}</td></tr>`;
                html += `<tr><td>Avg Sleep Improvement</td><td style="color: ${avgImprovementEast > 0 ? '#16a34a' : '#dc2626'}">${avgImprovementEast}</td></tr>`;
                html += '</tbody></table></div>';
            } else {
                html += '<p>No eastward travel data available</p></div>';
            }

            // Westward analysis
            html += '<div><h4>üåá Westward Travel (Less Severe Jet Lag)</h4>';
            if (westwardSurveys.length > 0) {
                const avgPointsWest = (westwardSurveys.reduce((sum, s) => sum + (s.pointsCompleted || 0), 0) / westwardSurveys.length).toFixed(1);
                const avgTzWest = (westwardSurveys.reduce((sum, s) => sum + (s.timezonesCount || 0), 0) / westwardSurveys.length).toFixed(1);
                
                const validWestSleep = westwardSurveys.filter(s => s.baselineSleep !== null && s.postSleepSeverity !== null);
                let avgImprovementWest = 'N/A';
                if (validWestSleep.length > 0) {
                    avgImprovementWest = (validWestSleep.reduce((sum, s) => sum + (s.baselineSleep - s.postSleepSeverity), 0) / validWestSleep.length).toFixed(2);
                }

                html += `<table class="data-table"><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody>`;
                html += `<tr><td>Sample Size</td><td>${westwardSurveys.length}</td></tr>`;
                html += `<tr><td>Avg Stimulation Points</td><td>${avgPointsWest}</td></tr>`;
                html += `<tr><td>Avg Time Zones</td><td>${avgTzWest}</td></tr>`;
                html += `<tr><td>Avg Sleep Improvement</td><td style="color: ${avgImprovementWest > 0 ? '#16a34a' : '#dc2626'}">${avgImprovementWest}</td></tr>`;
                html += '</tbody></table></div>';
            } else {
                html += '<p>No westward travel data available</p></div>';
            }

            html += '</div>';

            // Add explanatory notes
            html += '<div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 1px solid #0ea5e9;">';       
            html += '<h4>üìä Analysis Notes:</h4>';
            html += '<ul style="margin: 10px 0; padding-left: 20px;">';                                                                         
            html += '<li><strong>Post-Travel Severity:</strong> Lower values = better outcomes (1-2 = mild, 3-4 = moderate, 5 = severe)</li>';                  
            html += '<li><strong>Protection Effect:</strong> Lower values = better protection (severity per time zone crossed)</li>';                
            html += '<li><strong>Core Hypothesis:</strong> More time zones = higher symptoms, but more stimulation = reduced increase</li>';               
            html += '<li><strong>Dose-Response:</strong> Higher stimulation levels should show lower protection effect values</li>';           
            html += '</ul>';
            html += '</div>';

            container.innerHTML = html;
        }

        // Render symptom analysis (updated for new data structure)
        function renderSymptomAnalysis() {
            const container = document.getElementById('symptomAnalysis');
            
            if (surveyData.length === 0) {
                container.innerHTML = '<div class="error">No survey data available</div>';
                return;
            }

            // Show comprehensive trip completion and survey statistics
            let html = '<table class="data-table"><thead><tr><th>Metric</th><th>Value</th><th>Details</th></tr></thead><tbody>';
            
            // Core metrics (moved from top stat cards)
            const totalTrips = surveyData.length;
            const completedTrips = surveyData.filter(s => s.surveyCompleted).length;
            const completionRate = Math.round((completedTrips/totalTrips)*100);
            
            // Recent surveys (last 7 days)
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recentCount = surveyData.filter(survey => {
                const surveyDate = survey.completionDate || survey.created || survey.timestamp;
                return surveyDate && surveyDate >= sevenDaysAgo;
            }).length;
            
            html += `<tr><td><strong>üìù Total Surveys</strong></td><td>${totalTrips}</td><td>Total research submissions collected</td></tr>`;
            html += `<tr><td><strong>üìÖ Recent Submissions</strong></td><td>${recentCount}</td><td>Surveys in the last 7 days</td></tr>`;
            html += `<tr><td><strong>‚úÖ Completion Rate</strong></td><td>${completionRate}%</td><td>Percentage of completed surveys</td></tr>`;
            
            // Additional trip completion statistics
            const iosTrips = surveyData.filter(s => s.platform === 'iOS').length;
            const webTrips = surveyData.filter(s => s.platform !== 'iOS').length;
            
            html += `<tr><td><strong>Completed Surveys</strong></td><td>${completedTrips}</td><td>${completionRate}% completion rate</td></tr>`;
            html += `<tr><td><strong>Web Survey Trips</strong></td><td>${webTrips}</td><td>${Math.round((webTrips/totalTrips)*100)}% of total</td></tr>`;

            html += '</tbody></table>';
            
            // Add travel patterns data
            html += '<h3 style="margin-top: 30px; margin-bottom: 15px;">Travel Patterns</h3>';
            
            // Travel direction analysis
            const directions = {};
            const platforms = {};
            
            surveyData.forEach(survey => {
                if (survey.travelDirection) {
                    directions[survey.travelDirection] = (directions[survey.travelDirection] || 0) + 1;
                }
                if (survey.platform) {
                    platforms[survey.platform] = (platforms[survey.platform] || 0) + 1;
                }
            });

            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">';
            
            // Travel direction chart
            html += '<div><h4>Travel Direction</h4><table class="data-table"><thead><tr><th>Direction</th><th>Count</th><th>%</th></tr></thead><tbody>';
            Object.entries(directions).forEach(([direction, count]) => {
                const percentage = ((count / surveyData.length) * 100).toFixed(1);
                html += `<tr><td>${direction}</td><td>${count}</td><td>${percentage}%</td></tr>`;
            });
            html += '</tbody></table></div>';

            // Platform usage chart
            html += '<div><h4>Platform Usage</h4><table class="data-table"><thead><tr><th>Platform</th><th>Count</th><th>%</th></tr></thead><tbody>';
            Object.entries(platforms).forEach(([platform, count]) => {
                const percentage = ((count / surveyData.length) * 100).toFixed(1);
                html += `<tr><td>${platform}</td><td>${count}</td><td>${percentage}%</td></tr>`;
            });
            html += '</tbody></table></div>';

            html += '</div>';
            
            container.innerHTML = html;
        }

        // Render travel patterns
        function renderTravelPatterns() {
            const container = document.getElementById('travelPatterns');
            
            if (surveyData.length === 0) {
                container.innerHTML = '<div class="error">No travel data available</div>';
                return;
            }

            // Travel direction analysis
            const directions = {};
            const platforms = {};
            
            surveyData.forEach(survey => {
                if (survey.travelDirection) {
                    directions[survey.travelDirection] = (directions[survey.travelDirection] || 0) + 1;
                }
                if (survey.platform) {
                    platforms[survey.platform] = (platforms[survey.platform] || 0) + 1;
                }
            });

            let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">';
            
            // Travel direction chart
            html += '<div><h3>Travel Direction</h3><table class="data-table"><thead><tr><th>Direction</th><th>Count</th><th>%</th></tr></thead><tbody>';
            Object.entries(directions).forEach(([direction, count]) => {
                const percentage = ((count / surveyData.length) * 100).toFixed(1);
                html += `<tr><td>${direction}</td><td>${count}</td><td>${percentage}%</td></tr>`;
            });
            html += '</tbody></table></div>';

            // Platform usage chart
            html += '<div><h3>Platform Usage</h3><table class="data-table"><thead><tr><th>Platform</th><th>Count</th><th>%</th></tr></thead><tbody>';
            Object.entries(platforms).forEach(([platform, count]) => {
                const percentage = ((count / surveyData.length) * 100).toFixed(1);
                html += `<tr><td>${platform}</td><td>${count}</td><td>${percentage}%</td></tr>`;
            });
            html += '</tbody></table></div>';

            html += '</div>';
            container.innerHTML = html;
        }

        // Render advanced analytics with comprehensive graphs
        function renderAdvancedAnalytics() {
            const container = document.getElementById('advancedAnalytics');
            
            if (surveyData.length === 0) {
                container.innerHTML = '<div class="error">No survey data available for advanced analytics</div>';
                return;
            }
            
            // Filter to only include completed surveys
            const completedSurveys = surveyData.filter(survey => survey.surveyCompleted === true);
            
            if (completedSurveys.length === 0) {
                container.innerHTML = '<div class="error">No completed surveys available for advanced analytics</div>';
                return;
            }
            
            let html = '<div style="margin-bottom: 30px;">';
            html += '<h3>Advanced Research Analytics</h3>';
            html += '<p>Comprehensive analysis of time zones, travel direction, and acupressure point effectiveness</p>';
            html += '</div>';
            
            // Create chart containers
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">';
            html += '<div><canvas id="doseResponseChart" width="400" height="300"></canvas></div>';
            html += '<div><canvas id="timezoneEffectChart" width="400" height="300"></canvas></div>';
            html += '</div>';
            
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">';
            html += '<div><canvas id="directionComparisonChart" width="400" height="300"></canvas></div>';
            html += '<div><canvas id="symptomEffectivenessChart" width="400" height="300"></canvas></div>';
            html += '</div>';
            
            html += '<div style="margin-bottom: 30px;">';
            html += '<h4>3D Heatmap Matrix: Time Zones √ó Points √ó Symptom Improvement</h4>';
            html += '<div id="heatmapContainer" style="background: white; padding: 20px; border-radius: 10px; margin-top: 15px;"></div>';
            html += '</div>';
            
            container.innerHTML = html;
            
            // Render all charts
            renderDoseResponseChart(completedSurveys);
            renderTimezoneEffectChart(completedSurveys);
            renderDirectionComparisonChart(completedSurveys);
            renderSymptomEffectivenessChart(completedSurveys);
            render3DHeatmap(completedSurveys);
        }
        
        // Render dose-response curve chart
        function renderDoseResponseChart(surveys) {
            const ctx = document.getElementById('doseResponseChart').getContext('2d');
            
            // Group by points completed
            const pointGroups = {};
            for (let i = 0; i <= 12; i++) {
                pointGroups[i] = surveys.filter(s => s.pointsCompleted === i);
            }
            
            // Calculate average sleep improvement for each point group
            const labels = [];
            const eastwardData = [];
            const westwardData = [];
            
            for (let points = 0; points <= 12; points++) {
                const group = pointGroups[points];
                if (group.length === 0) continue;
                
                labels.push(`${points} points`);
                
                // Calculate for eastward travel
                const eastwardGroup = group.filter(s => s.travelDirection === 'Eastward');
                const eastwardImprovement = calculateAverageImprovement(eastwardGroup, 'sleep');
                eastwardData.push(eastwardImprovement);
                
                // Calculate for westward travel
                const westwardGroup = group.filter(s => s.travelDirection === 'Westward');
                const westwardImprovement = calculateAverageImprovement(westwardGroup, 'sleep');
                westwardData.push(westwardImprovement);
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Eastward Travel',
                        data: eastwardData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: false
                    }, {
                        label: 'Westward Travel',
                        data: westwardData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Dose-Response Curve: Points vs Sleep Improvement'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Sleep Improvement (Baseline - Post)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Acupressure Points Used'
                            }
                        }
                    }
                }
            });
        }
        
        // Render time zone effect chart
        function renderTimezoneEffectChart(surveys) {
            const ctx = document.getElementById('timezoneEffectChart').getContext('2d');
            
            // Group by time zone ranges
            const tzGroups = {
                '1-3': surveys.filter(s => s.timezonesCount >= 1 && s.timezonesCount <= 3),
                '4-6': surveys.filter(s => s.timezonesCount >= 4 && s.timezonesCount <= 6),
                '7-9': surveys.filter(s => s.timezonesCount >= 7 && s.timezonesCount <= 9),
                '10+': surveys.filter(s => s.timezonesCount >= 10)
            };
            
            const labels = Object.keys(tzGroups);
            const highStimulationData = []; // 6+ points
            const lowStimulationData = [];  // 0-5 points
            
            labels.forEach(tzRange => {
                const group = tzGroups[tzRange];
                const highStim = group.filter(s => s.pointsCompleted >= 6);
                const lowStim = group.filter(s => s.pointsCompleted <= 5);
                
                highStimulationData.push(calculateAverageImprovement(highStim, 'sleep'));
                lowStimulationData.push(calculateAverageImprovement(lowStim, 'sleep'));
            });
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'High Stimulation (6+ points)',
                        data: highStimulationData,
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Low Stimulation (0-5 points)',
                        data: lowStimulationData,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Time Zone Effect: Stimulation Level vs Sleep Improvement'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Average Sleep Improvement'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time Zones Crossed'
                            }
                        }
                    }
                }
            });
        }
        
        // Render direction comparison chart
        function renderDirectionComparisonChart(surveys) {
            const ctx = document.getElementById('directionComparisonChart').getContext('2d');
            
            const eastwardSurveys = surveys.filter(s => s.travelDirection === 'Eastward');
            const westwardSurveys = surveys.filter(s => s.travelDirection === 'Westward');
            
            const symptoms = ['Sleep', 'Fatigue', 'Concentration', 'Irritability', 'GI'];
            const eastwardData = [];
            const westwardData = [];
            
            symptoms.forEach(symptom => {
                const eastwardImprovement = calculateAverageImprovement(eastwardSurveys, symptom.toLowerCase());
                const westwardImprovement = calculateAverageImprovement(westwardSurveys, symptom.toLowerCase());
                
                eastwardData.push(eastwardImprovement);
                westwardData.push(westwardImprovement);
            });
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: symptoms,
                    datasets: [{
                        label: 'Eastward Travel',
                        data: eastwardData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.2)',
                        pointBackgroundColor: '#ef4444',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#ef4444'
                    }, {
                        label: 'Westward Travel',
                        data: westwardData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Symptom Improvement: Eastward vs Westward Travel'
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Improvement Score'
                            }
                        }
                    }
                }
            });
        }
        
        // Render symptom effectiveness chart
        function renderSymptomEffectivenessChart(surveys) {
            const ctx = document.getElementById('symptomEffectivenessChart').getContext('2d');
            
            const symptoms = ['Sleep', 'Fatigue', 'Concentration', 'Irritability', 'GI'];
            const effectivenessData = [];
            
            symptoms.forEach(symptom => {
                const improvement = calculateAverageImprovement(surveys, symptom.toLowerCase());
                effectivenessData.push(improvement);
            });
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: symptoms,
                    datasets: [{
                        data: effectivenessData,
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(168, 85, 247, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            'rgba(34, 197, 94, 1)',
                            'rgba(59, 130, 246, 1)',
                            'rgba(168, 85, 247, 1)',
                            'rgba(239, 68, 68, 1)',
                            'rgba(245, 158, 11, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Overall Symptom Improvement Distribution'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Render 3D heatmap matrix
        function render3DHeatmap(surveys) {
            const container = document.getElementById('heatmapContainer');
            
            // Create time zone ranges
            const tzRanges = ['1-3', '4-6', '7-9', '10+'];
            const pointRanges = ['0', '1-3', '4-6', '7-9', '10-12'];
            
            let html = '<div style="overflow-x: auto;">';
            html += '<table style="border-collapse: collapse; width: 100%; font-size: 0.9rem;">';
            
            // Header row
            html += '<thead><tr><th style="padding: 10px; border: 1px solid #ddd; background: #f8f9fa;">Points Used</th>';
            tzRanges.forEach(tz => {
                html += `<th style="padding: 10px; border: 1px solid #ddd; background: #f8f9fa; text-align: center;">${tz} TZ</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Data rows
            pointRanges.forEach(pointRange => {
                html += `<tr><td style="padding: 10px; border: 1px solid #ddd; background: #f8f9fa; font-weight: bold;">${pointRange}</td>`;
                
                tzRanges.forEach(tzRange => {
                    const [tzMin, tzMax] = tzRange === '10+' ? [10, 99] : tzRange.split('-').map(Number);
                    const [ptMin, ptMax] = pointRange === '0' ? [0, 0] : 
                                         pointRange === '10-12' ? [10, 12] : 
                                         pointRange.split('-').map(Number);
                    
                    const group = surveys.filter(s => {
                        const tz = s.timezonesCount || 0;
                        const pts = s.pointsCompleted || 0;
                        return tz >= tzMin && tz <= tzMax && pts >= ptMin && pts <= ptMax;
                    });
                    
                    const improvement = calculateAverageImprovement(group, 'sleep');
                    const sampleSize = group.length;
                    
                    // Color coding based on improvement
                    let bgColor = '#f8f9fa';
                    let textColor = '#000';
                    
                    if (sampleSize > 0) {
                        if (improvement > 1.5) {
                            bgColor = '#dcfce7'; // Light green
                            textColor = '#166534';
                        } else if (improvement > 0.5) {
                            bgColor = '#fef3c7'; // Light yellow
                            textColor = '#92400e';
                        } else if (improvement > 0) {
                            bgColor = '#fef2f2'; // Light red
                            textColor = '#991b1b';
                        } else {
                            bgColor = '#f3f4f6'; // Light gray
                            textColor = '#6b7280';
                        }
                    }
                    
                    html += `<td style="padding: 10px; border: 1px solid #ddd; background: ${bgColor}; color: ${textColor}; text-align: center;">`;
                    html += `<div style="font-weight: bold;">${improvement.toFixed(2)}</div>`;
                    html += `<div style="font-size: 0.8em; opacity: 0.7;">n=${sampleSize}</div>`;
                    html += '</td>';
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            html += '<div style="margin-top: 15px; padding: 10px; background: #f0f9ff; border-radius: 5px; font-size: 0.9em;">';
            html += '<strong>Legend:</strong> Values show average sleep improvement (baseline - post-travel). ';
            html += 'Green = High improvement (>1.5), Yellow = Moderate (0.5-1.5), Red = Low (0-0.5), Gray = No data.';
            html += '</div>';
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Helper function to calculate average improvement
        function calculateAverageImprovement(surveys, symptom) {
            if (surveys.length === 0) return 0;
            
            const validSurveys = surveys.filter(s => {
                const baseline = s[`baseline${symptom.charAt(0).toUpperCase() + symptom.slice(1)}`];
                const post = s[`post${symptom.charAt(0).toUpperCase() + symptom.slice(1)}Severity`];
                return baseline !== null && post !== null;
            });
            
            if (validSurveys.length === 0) return 0;
            
            const totalImprovement = validSurveys.reduce((sum, s) => {
                const baseline = s[`baseline${symptom.charAt(0).toUpperCase() + symptom.slice(1)}`];
                const post = s[`post${symptom.charAt(0).toUpperCase() + symptom.slice(1)}Severity`];
                return sum + (baseline - post);
            }, 0);
            
            return totalImprovement / validSurveys.length;
        }

        // Render recent submissions
        function renderRecentSubmissions() {
            const container = document.getElementById('recentSubmissions');
            
            if (surveyData.length === 0) {
                container.innerHTML = '<div class="error">No submission data available</div>';
                return;
            }

            // Sort by date (most recent first) and take the first 100
            const recentSurveys = surveyData
                .sort((a, b) => {
                    const dateA = a.completionDate || a.created || a.timestamp;
                    const dateB = b.completionDate || b.created || b.timestamp;
                    return new Date(dateB) - new Date(dateA); // Most recent first
                })
                .slice(0, 100);
            let html = '<table class="data-table"><thead><tr><th>Date</th><th>Code</th><th>Destination</th><th>East/West</th><th>Timezones</th><th>Status</th></tr></thead><tbody>';

            recentSurveys.forEach(survey => {
                const date = survey.completionDate || survey.created || survey.timestamp;
                const dateStr = date ? new Date(date).toLocaleDateString() : 'N/A';
                const isComplete = survey.surveyCompleted;
                const status = isComplete ? '‚úÖ Complete' : '‚ö†Ô∏è Partial';
                const statusColor = isComplete ? '#16a34a' : '#f59e0b';
                
                // Convert travel direction to East/West format
                // If timezones is 0, there's no travel, so direction should be N/A
                const timezones = survey.timezonesCount || 0;
                const direction = (timezones === 0) ? 'N/A' : (survey.travelDirection || 'N/A');
                const eastWest = direction === 'east' ? 'üåÖ East' : direction === 'west' ? 'üåá West' : 'N/A';

                html += `<tr>
                    <td>${dateStr}</td>
                    <td><code>${survey.surveyCode || 'N/A'}</code></td>
                    <td>${survey.destinationCode || 'N/A'}</td>
                    <td>${eastWest}</td>
                    <td>${survey.timezonesCount || 0}</td>
                    <td style="color: ${statusColor}">${status}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Show loading state
        function showLoadingState() {
            document.getElementById('symptomAnalysis').innerHTML = '<div class="loading">Loading trip data...</div>';
            document.getElementById('stimulationEfficacy').innerHTML = '<div class="loading">Loading efficacy data...</div>';
            document.getElementById('recentSubmissions').innerHTML = '<div class="loading">Loading recent data...</div>';
        }

        // Show error message
        function showError(message) {
            const container = document.getElementById('symptomAnalysis');
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        // Refresh data function
        function refreshData() {
            console.log('üîÑ Refreshing dashboard data...');
            loadDashboardData();
        }

        // Initialize dashboard when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });

        // Auto-refresh every 5 minutes
        setInterval(() => {
            if (!isLoading) {
                console.log('üîÑ Auto-refreshing dashboard data...');
                loadDashboardData();
            }
        }, 5 * 60 * 1000);

        // SQL Builder Functions
        let activeFilters = [];
        let queryResults = [];

        // Select all fields except individual point completion fields (1-12)
        function selectAllFields() {
            const checkboxes = document.querySelectorAll('.field-selector input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                // Skip individual point completion fields (point1Completed through point12Completed)
                if (!checkbox.value.match(/^point\d+Completed$/)) {
                    checkbox.checked = true;
                }
            });
            console.log('‚úÖ Selected all fields (excluding individual points 1-12)');
        }

        // Clear all field selections
        function clearAllFields() {
            const checkboxes = document.querySelectorAll('.field-selector input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            console.log('üóëÔ∏è Cleared all field selections');
        }

        // Add filter to the query
        function addFilter() {
            const field = document.getElementById('filterField').value;
            const operator = document.getElementById('filterOperator').value;
            const value = document.getElementById('filterValue').value;
            
            if (!value) {
                alert('Please enter a filter value');
                return;
            }
            
            const filter = { field, operator, value, id: Date.now() };
            activeFilters.push(filter);
            displayActiveFilters();
            
            // Clear the input
            document.getElementById('filterValue').value = '';
        }

        // Display active filters
        function displayActiveFilters() {
            const container = document.getElementById('activeFilters');
            container.innerHTML = '';
            
            activeFilters.forEach(filter => {
                const filterTag = document.createElement('span');
                filterTag.className = 'filter-tag';
                filterTag.innerHTML = `${filter.field} ${filter.operator} ${filter.value} <span class="remove" onclick="removeFilter(${filter.id})">√ó</span>`;
                container.appendChild(filterTag);
            });
        }

        // Remove filter
        function removeFilter(filterId) {
            activeFilters = activeFilters.filter(f => f.id !== filterId);
            displayActiveFilters();
        }

        // Execute the query
        function executeQuery() {
            try {
                console.log('üîç Executing custom query...');
                
                // Get selected fields
                const selectedFields = Array.from(document.querySelectorAll('.field-selector input:checked'))
                    .map(cb => cb.value);
                
                if (selectedFields.length === 0) {
                    alert('Please select at least one field');
                    return;
                }
                
                // Get grouping
                const groupByField = document.getElementById('groupByField').value;
                
                // Get aggregations
                const aggregations = Array.from(document.querySelectorAll('.aggregate-selector input:checked'))
                    .map(cb => cb.value);
                
                // Apply filters
                let filteredData = [...surveyData];
                
                activeFilters.forEach(filter => {
                    filteredData = filteredData.filter(item => {
                        const itemValue = item[filter.field];
                        const filterValue = filter.value;
                        
                        switch (filter.operator) {
                            case 'equals':
                                return itemValue == filterValue;
                            case 'notEquals':
                                return itemValue != filterValue;
                            case 'greaterThan':
                                return Number(itemValue) > Number(filterValue);
                            case 'lessThan':
                                return Number(itemValue) < Number(filterValue);
                            case 'contains':
                                return String(itemValue).toLowerCase().includes(filterValue.toLowerCase());
                            default:
                                return true;
                        }
                    });
                });
                
                // Apply grouping and aggregations
                if (groupByField && aggregations.length > 0) {
                    const grouped = {};
                    
                    filteredData.forEach(item => {
                        const groupValue = item[groupByField] || 'Unknown';
                        if (!grouped[groupValue]) {
                            grouped[groupValue] = [];
                        }
                        grouped[groupValue].push(item);
                    });
                    
                    // Calculate aggregations for each group
                    queryResults = Object.entries(grouped).map(([groupValue, items]) => {
                        const result = { [groupByField]: groupValue };
                        
                        aggregations.forEach(agg => {
                            switch (agg) {
                                case 'count':
                                    result.count = items.length;
                                    break;
                                case 'avg':
                                    // Calculate average for numeric fields
                                    const numericFields = selectedFields.filter(field => 
                                        typeof items[0][field] === 'number'
                                    );
                                    numericFields.forEach(field => {
                                        const values = items.map(item => item[field]).filter(v => v != null);
                                        if (values.length > 0) {
                                            result[`avg_${field}`] = (values.reduce((a, b) => a + b, 0) / values.length).toFixed(2);
                                        }
                                    });
                                    break;
                                case 'sum':
                                    const sumFields = selectedFields.filter(field => 
                                        typeof items[0][field] === 'number'
                                    );
                                    sumFields.forEach(field => {
                                        const values = items.map(item => item[field]).filter(v => v != null);
                                        if (values.length > 0) {
                                            result[`sum_${field}`] = values.reduce((a, b) => a + b, 0);
                                        }
                                    });
                                    break;
                                case 'min':
                                    const minFields = selectedFields.filter(field => 
                                        typeof items[0][field] === 'number'
                                    );
                                    minFields.forEach(field => {
                                        const values = items.map(item => item[field]).filter(v => v != null);
                                        if (values.length > 0) {
                                            result[`min_${field}`] = Math.min(...values);
                                        }
                                    });
                                    break;
                                case 'max':
                                    const maxFields = selectedFields.filter(field => 
                                        typeof items[0][field] === 'number'
                                    );
                                    maxFields.forEach(field => {
                                        const values = items.map(item => item[field]).filter(v => v != null);
                                        if (values.length > 0) {
                                            result[`max_${field}`] = Math.max(...values);
                                        }
                                    });
                                    break;
                            }
                        });
                        
                        return result;
                    });
                } else {
                    // No grouping, just show filtered data with selected fields
                    queryResults = filteredData.map(item => {
                        const result = {};
                        selectedFields.forEach(field => {
                            result[field] = item[field];
                        });
                        return result;
                    });
                }
                
                // Display results
                displayQueryResults();
                
                console.log('‚úÖ Query executed successfully');
                console.log('Results:', queryResults);
                
            } catch (error) {
                console.error('‚ùå Query execution failed:', error);
                alert('Query execution failed: ' + error.message);
            }
        }

        // Display query results
        function displayQueryResults() {
            const container = document.getElementById('queryResults');
            
            if (queryResults.length === 0) {
                container.innerHTML = '<p>No results found for this query.</p>';
                return;
            }
            
            // Create summary
            const summary = document.createElement('div');
            summary.className = 'query-summary';
            summary.innerHTML = `
                <strong>Query Results:</strong> ${queryResults.length} records found
                ${activeFilters.length > 0 ? `with ${activeFilters.length} filter(s) applied` : ''}
            `;
            
            // Create results table
            const table = document.createElement('table');
            table.className = 'results-table';
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const fields = Object.keys(queryResults[0]);
            
            fields.forEach(field => {
                const th = document.createElement('th');
                th.textContent = field.charAt(0).toUpperCase() + field.slice(1);
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            queryResults.forEach(result => {
                const row = document.createElement('tr');
                fields.forEach(field => {
                    const td = document.createElement('td');
                    td.textContent = result[field] !== null && result[field] !== undefined ? result[field] : 'N/A';
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            
            // Clear and populate container
            container.innerHTML = '';
            container.appendChild(summary);
            container.appendChild(table);
        }

        // Pre-built research queries
        function runPrebuiltQuery(queryType) {
            try {
                console.log(`üîç Running pre-built query: ${queryType}`);
                
                        switch (queryType) {
            case 'stimulation-efficacy':
                runStimulationEfficacyQuery();
                break;
            case 'timezone-effect':
                runTimezoneEffectQuery();
                break;
            case 'travel-direction':
                runTravelDirectionQuery();
                break;
            case 'dose-response':
                runDoseResponseQuery();
                break;
            case 'symptom-comparison':
                runSymptomComparisonQuery();
                break;
            default:
                alert('Unknown query type');
        }
                
            } catch (error) {
                console.error('‚ùå Pre-built query failed:', error);
                alert('Query failed: ' + error.message);
            }
        }

        // Stimulation efficacy analysis
        function runStimulationEfficacyQuery() {
            const results = [];
            
            // Filter to only include completed surveys
            const completedSurveys = surveyData.filter(survey => survey.surveyCompleted === true);
            
            // Group by stimulation level
            const groups = {};
            completedSurveys.forEach(survey => {
                const points = survey.pointsCompleted || 0;
                const group = points === 0 ? '0' : points <= 3 ? '1-3' : points <= 6 ? '4-6' : points <= 9 ? '7-9' : '10-12';
                
                if (!groups[group]) groups[group] = [];
                groups[group].push(survey);
            });

            Object.entries(groups).forEach(([group, surveys]) => {
                if (surveys.length === 0) return;
                
                const result = {
                    'Stimulation Level': group + ' points',
                    'Sample Size': surveys.length,
                    'Avg Points Used': (surveys.reduce((sum, s) => sum + (s.pointsCompleted || 0), 0) / surveys.length).toFixed(1),
                    'Avg Timezones': (surveys.reduce((sum, s) => sum + (s.timezonesCount || 0), 0) / surveys.length).toFixed(1)
                };

                // Add symptom improvements if data available
                const validSurveys = surveys.filter(s => s.baselineSleep !== null && s.postSleepSeverity !== null);
                if (validSurveys.length > 0) {
                    const avgImprovement = validSurveys.reduce((sum, s) => sum + (s.baselineSleep - s.postSleepSeverity), 0) / validSurveys.length;
                    result['Avg Sleep Improvement'] = avgImprovement.toFixed(2);
                }

                results.push(result);
            });

            queryResults = results;
            displayQueryResults();
        }

        // Travel direction analysis
        function runTravelDirectionQuery() {
            const results = [];
            
            // Filter to only include completed surveys
            const completedSurveys = surveyData.filter(survey => survey.surveyCompleted === true);
            
            // Group by travel direction
            const directions = {};
            completedSurveys.forEach(survey => {
                const direction = survey.travelDirection || 'Unknown';
                if (!directions[direction]) directions[direction] = [];
                directions[direction].push(survey);
            });

            Object.entries(directions).forEach(([direction, surveys]) => {
                if (surveys.length === 0) return;
                
                const result = {
                    'Travel Direction': direction,
                    'Sample Size': surveys.length,
                    'Avg Stimulation Points': (surveys.reduce((sum, s) => sum + (s.pointsCompleted || 0), 0) / surveys.length).toFixed(1),
                    'Avg Time Zones': (surveys.reduce((sum, s) => sum + (s.timezonesCount || 0), 0) / surveys.length).toFixed(1)
                };

                // Add symptom data if available
                const validSurveys = surveys.filter(s => s.baselineSleep !== null && s.postSleepSeverity !== null);
                if (validSurveys.length > 0) {
                    const avgBaseline = validSurveys.reduce((sum, s) => sum + s.baselineSleep, 0) / validSurveys.length;
                    const avgPost = validSurveys.reduce((sum, s) => sum + s.postSleepSeverity, 0) / validSurveys.length;
                    const avgImprovement = avgBaseline - avgPost;
                    
                    result['Avg Baseline Sleep'] = avgBaseline.toFixed(2);
                    result['Avg Post-Travel Sleep'] = avgPost.toFixed(2);
                    result['Avg Sleep Improvement'] = avgImprovement.toFixed(2);
                    result['Improvement Rate'] = ((avgImprovement / avgBaseline) * 100).toFixed(1) + '%';
                }

                // Add anticipated vs actual comparison
                const validAnticipatedSurveys = surveys.filter(s => s.anticipatedSleepSeverity !== null && s.postSleepSeverity !== null);
                if (validAnticipatedSurveys.length > 0) {
                    const avgAnticipated = validAnticipatedSurveys.reduce((sum, s) => sum + s.anticipatedSleepSeverity, 0) / validAnticipatedSurveys.length;
                    const avgActual = validAnticipatedSurveys.reduce((sum, s) => sum + s.postSleepSeverity, 0) / validAnticipatedSurveys.length;
                    const expectationExceeded = avgAnticipated - avgActual;
                    
                    result['Avg Anticipated Severity'] = avgAnticipated.toFixed(2);
                    result['Expectation Exceeded'] = expectationExceeded.toFixed(2);
                }

                results.push(result);
            });

            queryResults = results;
            displayQueryResults();
        }

        // Time zone effect analysis
        function runTimezoneEffectQuery() {
            const results = [];
            
            // Filter to only include completed surveys
            const completedSurveys = surveyData.filter(survey => survey.surveyCompleted === true);
            
            // Group by time zone ranges
            const tzGroups = {
                '1-3': [],
                '4-6': [],
                '7-9': [],
                '10+': []
            };

            completedSurveys.forEach(survey => {
                const tz = survey.timezonesCount || 0;
                if (tz <= 3) tzGroups['1-3'].push(survey);
                else if (tz <= 6) tzGroups['4-6'].push(survey);
                else if (tz <= 9) tzGroups['7-9'].push(survey);
                else tzGroups['10+'].push(survey);
            });

            Object.entries(tzGroups).forEach(([range, surveys]) => {
                if (surveys.length === 0) return;
                
                const result = {
                    'Time Zones': range,
                    'Sample Size': surveys.length,
                    'Avg Stimulation Points': (surveys.reduce((sum, s) => sum + (s.pointsCompleted || 0), 0) / surveys.length).toFixed(1)
                };

                // Add symptom data if available
                const validSurveys = surveys.filter(s => s.postSleepSeverity !== null);
                if (validSurveys.length > 0) {
                    const avgPostSleep = validSurveys.reduce((sum, s) => sum + s.postSleepSeverity, 0) / validSurveys.length;
                    result['Avg Post-Travel Sleep Severity'] = avgPostSleep.toFixed(2);
                }

                // Add baseline improvement data
                const validBaselineSurveys = surveys.filter(s => s.baselineSleep !== null && s.postSleepSeverity !== null);
                if (validBaselineSurveys.length > 0) {
                    const avgImprovement = validBaselineSurveys.reduce((sum, s) => sum + (s.baselineSleep - s.postSleepSeverity), 0) / validBaselineSurveys.length;
                    result['Avg Sleep Improvement'] = avgImprovement.toFixed(2);
                    result['Improvement per Time Zone'] = (avgImprovement / parseInt(range.split('-')[0])).toFixed(3);
                }

                results.push(result);
            });

            queryResults = results;
            displayQueryResults();
        }

        // Dose-response curve analysis
        function runDoseResponseQuery() {
            const results = [];
            
            // Filter to only include completed surveys
            const completedSurveys = surveyData.filter(survey => survey.surveyCompleted === true);
            
            // Create point-by-point analysis
            for (let points = 0; points <= 12; points++) {
                const surveys = completedSurveys.filter(s => s.pointsCompleted === points);
                if (surveys.length === 0) continue;
                
                const result = {
                    'Points Used': points,
                    'Sample Size': surveys.length,
                    'Avg Timezones': (surveys.reduce((sum, s) => sum + (s.timezonesCount || 0), 0) / surveys.length).toFixed(1)
                };

                // Calculate symptom improvements
                const validSurveys = surveys.filter(s => s.baselineSleep !== null && s.postSleepSeverity !== null);
                if (validSurveys.length > 0) {
                    const avgImprovement = validSurveys.reduce((sum, s) => sum + (s.baselineSleep - s.postSleepSeverity), 0) / validSurveys.length;
                    result['Avg Sleep Improvement'] = avgImprovement.toFixed(2);
                }

                results.push(result);
            }

            queryResults = results;
            displayQueryResults();
        }

        // Symptom comparison analysis
        function runSymptomComparisonQuery() {
            const results = [];
            
            // Filter to only include completed surveys
            const completedSurveys = surveyData.filter(survey => survey.surveyCompleted === true);
            
            // Compare all symptom types
            const symptoms = ['Sleep', 'Fatigue', 'Concentration', 'Irritability', 'GI'];
            
            symptoms.forEach(symptom => {
                const result = {
                    'Symptom Type': symptom,
                    'Total Surveys': completedSurveys.length
                };

                // Calculate baseline vs post for each symptom
                const validSurveys = completedSurveys.filter(s => {
                    const baseline = s[`baseline${symptom}`];
                    const post = s[`post${symptom}Severity`];
                    return baseline !== null && post !== null;
                });

                if (validSurveys.length > 0) {
                    const avgBaseline = validSurveys.reduce((sum, s) => sum + s[`baseline${symptom}`], 0) / validSurveys.length;
                    const avgPost = validSurveys.reduce((sum, s) => sum + s[`post${symptom}Severity`], 0) / validSurveys.length;
                    const avgImprovement = avgBaseline - avgPost;
                    
                    result['Valid Surveys'] = validSurveys.length;
                    result['Avg Baseline'] = avgBaseline.toFixed(2);
                    result['Avg Post-Travel'] = avgPost.toFixed(2);
                    result['Avg Improvement'] = avgImprovement.toFixed(2);
                }

                results.push(result);
            });

            queryResults = results;
            displayQueryResults();
        }

        // Export results to CSV
        function exportResults() {
            if (queryResults.length === 0) {
                alert('No results to export. Please execute a query first.');
                return;
            }
            
            try {
                const fields = Object.keys(queryResults[0]);
                const csvContent = [
                    fields.join(','), // Header row
                    ...queryResults.map(result => 
                        fields.map(field => {
                            const value = result[field];
                            // Escape commas and quotes in CSV
                            if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                                return `"${value.replace(/"/g, '""')}"`;
                            }
                            return value !== null && value !== undefined ? value : '';
                        }).join(',')
                    )
                ].join('\n');
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `jetlagpro_analysis_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                console.log('üìä CSV exported successfully');
                
            } catch (error) {
                console.error('‚ùå CSV export failed:', error);
                alert('Export failed: ' + error.message);
            }
        }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 10px;
            text-align: center;
        }

        .header p {
            font-size: 1.1rem;
            color: #6b7280;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .stat-card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 10px;
        }

        .stat-description {
            color: #6b7280;
            font-size: 0.95rem;
        }

        .data-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .data-section h2 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .data-table tr:hover {
            background: #f9fafb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            font-size: 1.1rem;
        }

        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: #2563eb;
        }

        .icon {
            font-size: 1.5rem;
        }

        /* SQL Builder Styles */
        .sql-builder {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .query-builder {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }

        .query-section {
            margin-bottom: 20px;
        }

        .query-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .field-selector, .aggregate-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
        }

        .field-selector h4 {
            grid-column: 1 / -1;
            margin: 15px 0 8px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .field-selector h4:first-child {
            margin-top: 0;
        }

        .select-all-controls {
            grid-column: 1 / -1;
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        .select-all-btn, .clear-all-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .select-all-btn:hover {
            background: #2563eb;
        }

        .clear-all-btn {
            background: #6b7280;
        }

        .clear-all-btn:hover {
            background: #4b5563;
        }

        .field-selector label, .aggregate-selector label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: normal;
            font-size: 0.9rem;
        }

        .filter-builder {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-builder select, .filter-builder input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .filter-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .filter-btn:hover {
            background: #059669;
        }

        .active-filters {
            margin-top: 10px;
            min-height: 20px;
        }

        .filter-tag {
            display: inline-block;
            background: #3b82f6;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 2px;
        }

        .filter-tag .remove {
            margin-left: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .execute-btn, .export-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            margin-right: 10px;
            transition: background 0.3s ease;
        }

        .execute-btn:hover, .export-btn:hover {
            background: #2563eb;
        }

        .export-btn {
            background: #10b981;
        }

        .export-btn:hover {
            background: #059669;
        }

        .prebuilt-btn {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .prebuilt-btn:hover {
            background: #7c3aed;
        }

        .query-results {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }

        .results-display {
            min-height: 200px;
            background: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .results-table th, .results-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }

        .results-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .query-summary {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            color: #0369a1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .stat-value {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä JetLagPro Analytics Dashboard</h1>
            <p>Research Data Analysis & Insights (REST API)</p>
        </div>

        <button class="refresh-btn" onclick="refreshData()">
            üîÑ Refresh Data
        </button>



        <div class="data-section">
            <h2><span class="icon">üî¨</span>Stimulation Efficacy Analysis</h2>
            <div id="stimulationEfficacy" class="loading">Loading efficacy data...</div>
        </div>

        <div class="data-section">
            <h2><span class="icon">üìà</span>Advanced Research Analytics</h2>
            <div id="advancedAnalytics" class="loading">Loading advanced analytics...</div>
        </div>

        <div class="data-section">
            <h2><span class="icon">üîç</span>Custom Data Analysis</h2>
            <div id="sqlBuilder" class="sql-builder">
                <div class="query-builder">
                    <h3>Build Your Query</h3>
                    
                                         <div class="query-section">
                         <label>Select Fields:</label>
                         <div class="field-selector">
                             <div class="select-all-controls">
                                 <button type="button" onclick="selectAllFields()" class="select-all-btn">Select All (Excluding Points 1-12)</button>
                                 <button type="button" onclick="clearAllFields()" class="clear-all-btn">Clear All</button>
                             </div>
                             
                             <h4>Basic Trip Info</h4>
                             <label><input type="checkbox" value="tripId" checked> Trip ID</label>
                             <label><input type="checkbox" value="surveyCode" checked> Survey Code</label>
                             <label><input type="checkbox" value="destinationCode"> Destination</label>
                             <label><input type="checkbox" value="startDate"> Start Date</label>
                             <label><input type="checkbox" value="completionDate"> Completion Date</label>
                             
                             <h4>Travel Details</h4>
                             <label><input type="checkbox" value="travelDirection"> Travel Direction</label>
                             <label><input type="checkbox" value="timezonesCount"> Timezones Count</label>
                             <label><input type="checkbox" value="direction"> Direction</label>
                             <label><input type="checkbox" value="purpose"> Purpose</label>
                             <label><input type="checkbox" value="travelExperience"> Travel Experience</label>
                             <label><input type="checkbox" value="flightDuration"> Flight Duration</label>
                             <label><input type="checkbox" value="flightLandingDate"> Flight Landing Date</label>
                             <label><input type="checkbox" value="flightLandingHour"> Flight Landing Hour</label>
                             

                             
                             <h4>Survey Results</h4>
                             <label><input type="checkbox" value="surveyCompleted"> Survey Completed</label>
                             <label><input type="checkbox" value="surveyVersion"> Survey Version</label>
                             <label><input type="checkbox" value="age"> Age</label>
                             <label><input type="checkbox" value="gender"> Gender</label>
                             <label><input type="checkbox" value="region"> Region</label>
                             
                             <h4>Baseline Symptoms</h4>
                             <label><input type="checkbox" value="baselineSleep"> Baseline Sleep</label>
                             <label><input type="checkbox" value="baselineFatigue"> Baseline Fatigue</label>
                             <label><input type="checkbox" value="baselineConcentration"> Baseline Concentration</label>
                             <label><input type="checkbox" value="baselineIrritability"> Baseline Irritability</label>
                             <label><input type="checkbox" value="baselineGi"> Baseline GI</label>
                             
                             <h4>Post-Travel Symptoms</h4>
                             <label><input type="checkbox" value="postSleepSeverity"> Post Sleep Severity</label>
                             <label><input type="checkbox" value="postFatigueSeverity"> Post Fatigue Severity</label>
                             <label><input type="checkbox" value="postConcentrationSeverity"> Post Concentration Severity</label>
                             <label><input type="checkbox" value="postIrritabilitySeverity"> Post Irritability Severity</label>
                             <label><input type="checkbox" value="postGiSeverity"> Post GI Severity</label>
                             
                             <h4>Anticipated Symptoms</h4>
                             <label><input type="checkbox" value="anticipatedSleepSeverity"> Anticipated Sleep Severity</label>
                             <label><input type="checkbox" value="anticipatedFatigueSeverity"> Anticipated Fatigue Severity</label>
                             <label><input type="checkbox" value="anticipatedConcentrationSeverity"> Anticipated Concentration Severity</label>
                             <label><input type="checkbox" value="anticipatedIrritabilitySeverity"> Anticipated Irritability Severity</label>
                             <label><input type="checkbox" value="anticipatedGiSeverity"> Anticipated GI Severity</label>
                             
                             <label><input type="checkbox" value="completionMethod"> Completion Method</label>
                                                       </div>
                      </div>

                    <div class="query-section">
                        <label>Filter Data:</label>
                        <div class="filter-builder">
                            <select id="filterField">
                                <option value="platform">Platform</option>
                                <option value="travelDirection">Travel Direction</option>
                                <option value="timezonesCount">Timezones Count</option>
                                <option value="pointsCompleted">Points Completed</option>
                                <option value="surveyCompleted">Survey Completed</option>
                                <option value="age">Age</option>
                                <option value="gender">Gender</option>
                                <option value="region">Region</option>
                                <option value="purpose">Purpose</option>
                                <option value="travelExperience">Travel Experience</option>
                                <option value="destinationCode">Destination</option>
                                <option value="surveyVersion">Survey Version</option>
                                <option value="completionMethod">Completion Method</option>
                            </select>
                            <select id="filterOperator">
                                <option value="equals">Equals</option>
                                <option value="notEquals">Not Equals</option>
                                <option value="greaterThan">Greater Than</option>
                                <option value="lessThan">Less Than</option>
                                <option value="contains">Contains</option>
                            </select>
                            <input type="text" id="filterValue" placeholder="Value">
                            <button onclick="addFilter()" class="filter-btn">Add Filter</button>
                        </div>
                        <div id="activeFilters" class="active-filters"></div>
                    </div>

                    <div class="query-section">
                        <label>Group By:</label>
                        <select id="groupByField">
                            <option value="">No Grouping</option>
                            <option value="platform">Platform</option>
                            <option value="travelDirection">Travel Direction</option>
                            <option value="timezonesCount">Timezones Count</option>
                            <option value="pointsCompleted">Points Completed</option>
                            <option value="age">Age</option>
                            <option value="gender">Gender</option>
                            <option value="region">Region</option>
                            <option value="purpose">Purpose</option>
                            <option value="travelExperience">Travel Experience</option>
                            <option value="destinationCode">Destination</option>
                            <option value="surveyVersion">Survey Version</option>
                        </select>
                    </div>

                    <div class="query-section">
                        <label>Aggregate:</label>
                        <div class="aggregate-selector">
                            <label><input type="checkbox" value="count"> Count</label>
                            <label><input type="checkbox" value="avg"> Average</label>
                            <label><input type="checkbox" value="sum"> Sum</label>
                            <label><input type="checkbox" value="min"> Min</label>
                            <label><input type="checkbox" value="max"> Max</label>
                        </div>
                    </div>

                                         <div class="query-section">
                         <button onclick="executeQuery()" class="execute-btn">üöÄ Execute Query</button>
                         <button onclick="exportResults()" class="export-btn">üìä Export CSV</button>
                     </div>

                     <div class="query-section">
                         <label>Pre-built Research Queries:</label>
                         <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                             <button onclick="runPrebuiltQuery('stimulation-efficacy')" class="prebuilt-btn">üî¨ Stimulation Efficacy</button>
                             <button onclick="runPrebuiltQuery('timezone-effect')" class="prebuilt-btn">üåç Time Zone Effect</button>
                             <button onclick="runPrebuiltQuery('travel-direction')" class="prebuilt-btn">üß≠ Travel Direction</button>
                             <button onclick="runPrebuiltQuery('dose-response')" class="prebuilt-btn">üìà Dose-Response Curve</button>
                             <button onclick="runPrebuiltQuery('symptom-comparison')" class="prebuilt-btn">‚öñÔ∏è Symptom Comparison</button>
                         </div>
                     </div>
                </div>

                <div class="query-results">
                    <h3>Query Results</h3>
                    <div id="queryResults" class="results-display">
                        <p>Build and execute a query to see results here.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="data-section">
            <h2><span class="icon">üìä</span>Trip Completion Analysis</h2>
            <div id="symptomAnalysis" class="loading">Loading trip data...</div>
        </div>

        <div class="data-section">
            <h2><span class="icon">üïí</span>Recent Submissions</h2>
            <div id="recentSubmissions" class="loading">Loading recent data...</div>
        </div>
    </div>
</body>
</html>
