<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JetLagPro Analytics Dashboard</title>
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="JetLagPro Research Data Analytics">
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, orderBy, limit, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Initialize Firebase function
        async function initializeFirebase() {
            try {
                console.log('üöÄ Starting Firebase initialization...');
                console.log('üì¶ Firebase SDKs imported successfully');

                // Your existing Firebase configuration from jetlagpro-research project
                const firebaseConfig = {
                    apiKey: "AIzaSyBcck2Ca7xBjlZcCwTcQBNQUueFsO0wyBA",
                    authDomain: "jetlagpro-research.firebaseapp.com",
                    projectId: "jetlagpro-research",
                    storageBucket: "jetlagpro-research.firebasestorage.app",
                    messagingSenderId: "202766013439",
                    appId: "1:202766013439:web:c835e22cf3a12332920dca",
                    measurementId: "G-8JV71DX3W3"
                };

                console.log('‚öôÔ∏è Firebase config loaded:', firebaseConfig);

                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                console.log('üî• Firebase app initialized:', app);
                
                const db = getFirestore(app);
                console.log('üóÑÔ∏è Firestore database initialized:', db);

                // Make Firebase available globally
                window.firebaseDB = db;
                window.firebaseCollection = collection;
                window.firebaseGetDocs = getDocs;
                window.firebaseQuery = query;
                window.firebaseOrderBy = orderBy;
                window.firebaseLimit = limit;
                window.firebaseWhere = where;

                console.log('‚úÖ Firebase Analytics Dashboard initialized successfully');
                console.log('Available Firebase functions:', {
                    firebaseDB: !!window.firebaseDB,
                    firebaseCollection: !!window.firebaseCollection,
                    firebaseGetDocs: !!window.firebaseGetDocs,
                    firebaseQuery: !!window.firebaseQuery,
                    firebaseOrderBy: !!window.firebaseOrderBy
                });
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Firebase initialization failed:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    type: error.constructor.name
                });
                
                // Show error on page
                const container = document.getElementById('symptomAnalysis');
                if (container) {
                    container.innerHTML = `<div class="error">
                        <h3>Firebase Connection Failed</h3>
                        <p>Error: ${error.message}</p>
                        <p>Please check the browser console for more details.</p>
                        <p><strong>Troubleshooting:</strong></p>
                        <ul>
                            <li>Check if you have internet connection</li>
                            <li>Verify the Firebase project is active</li>
                            <li>Check browser console for detailed errors</li>
                            <li>Verify collection name: tripCompletions</li>
                        </ul>
                    </div>`;
                }
                
                return false;
            }
        }

        // Initialize Firebase when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            const success = await initializeFirebase();
            if (success) {
                // Start loading dashboard data
                console.log('üöÄ Analytics Dashboard initializing...');
                loadDashboardData();
            }
        });
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 10px;
            text-align: center;
        }

        .header p {
            font-size: 1.1rem;
            color: #6b7280;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .stat-card h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 10px;
        }

        .stat-description {
            color: #6b7280;
            font-size: 0.95rem;
        }

        .data-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .data-section h2 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .data-table tr:hover {
            background: #f9fafb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            font-size: 1.1rem;
        }

        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: #2563eb;
        }

        .icon {
            font-size: 1.5rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .stat-value {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä JetLagPro Analytics Dashboard</h1>
            <p>Research Data Analysis & Insights</p>
        </div>

        <button class="refresh-btn" onclick="refreshData()">
            üîÑ Refresh Data
        </button>

        <div class="stats-grid">
            <div class="stat-card">
                <h3><span class="icon">üìù</span>Total Surveys</h3>
                <div class="stat-value" id="totalSurveys">-</div>
                <div class="stat-description">Total research submissions collected</div>
            </div>

            <div class="stat-card">
                <h3><span class="icon">üìÖ</span>Recent Submissions</h3>
                <div class="stat-value" id="recentSurveys">-</div>
                <div class="stat-description">Surveys in the last 7 days</div>
            </div>

            <div class="stat-card">
                <h3><span class="icon">‚úÖ</span>Completion Rate</h3>
                <div class="stat-value" id="completionRate">-</div>
                <div class="stat-description">Percentage of completed surveys</div>
            </div>

            <div class="stat-card">
                <h3><span class="icon">üåç</span>Timezone Coverage</h3>
                <div class="stat-value" id="timezoneCount">-</div>
                <div class="stat-description">Unique timezones represented</div>
            </div>
        </div>

        <div class="data-section">
            <h2><span class="icon">üìä</span>Symptom Analysis</h2>
            <div id="symptomAnalysis" class="loading">Loading symptom data...</div>
        </div>

        <div class="data-section">
            <h2><span class="icon">‚úàÔ∏è</span>Travel Patterns</h2>
            <div id="travelPatterns" class="loading">Loading travel data...</div>
        </div>

        <div class="data-section">
            <h2><span class="icon">üïí</span>Recent Submissions</h2>
            <div id="recentSubmissions" class="loading">Loading recent data...</div>
        </div>
    </div>

    <script>
        // Global variables for data
        let surveyData = [];
        let isLoading = true;

        // Load all dashboard data
        async function loadDashboardData() {
            try {
                isLoading = true;
                showLoadingState();
                
                console.log('üìä Loading survey data from Firebase...');
                await loadSurveyData();
                
                console.log('üìà Calculating statistics...');
                calculateStatistics();
                
                console.log('üìä Rendering dashboard...');
                renderDashboard();
                
                isLoading = false;
                console.log('‚úÖ Dashboard loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Error loading dashboard:', error);
                showError('Failed to load dashboard data: ' + error.message);
                isLoading = false;
            }
        }

        // Load survey data from Firebase
        async function loadSurveyData() {
            try {
                console.log('üîç Checking Firebase connection...');
                console.log('Firebase DB:', window.firebaseDB);
                console.log('Firebase Collection:', window.firebaseCollection);
                
                if (!window.firebaseDB) {
                    throw new Error('Firebase database not initialized');
                }
                
                console.log('üìä Querying surveys collection...');
                const surveysRef = window.firebaseCollection(window.firebaseDB, 'surveys');
                console.log('Surveys reference:', surveysRef);
                
                const q = window.firebaseQuery(surveysRef, window.firebaseOrderBy('timestamp', 'desc'));
                console.log('Query created:', q);
                
                console.log('üì• Executing query...');
                const querySnapshot = await window.firebaseGetDocs(q);
                console.log('Query result:', querySnapshot);
                
                surveyData = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    data.id = doc.id;
                    surveyData.push(data);
                    console.log('üìù Survey data:', data);
                });
                
                console.log(`üìù Loaded ${surveyData.length} survey records`);
                
            } catch (error) {
                console.error('‚ùå Error loading survey data:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    firebaseDB: !!window.firebaseDB,
                    firebaseCollection: !!window.firebaseCollection,
                    firebaseGetDocs: !!window.firebaseGetDocs,
                    firebaseQuery: !!window.firebaseQuery,
                    firebaseOrderBy: !!window.firebaseOrderBy
                });
                throw new Error('Failed to load survey data from Firebase: ' + error.message);
            }
        }

        // Calculate key statistics
        function calculateStatistics() {
            if (surveyData.length === 0) return;

            // Total surveys
            document.getElementById('totalSurveys').textContent = surveyData.length;

            // Recent surveys (last 7 days)
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recentCount = surveyData.filter(survey => {
                const surveyDate = survey.timestamp?.toDate?.() || new Date(survey.timestamp);
                return surveyDate >= sevenDaysAgo;
            }).length;
            document.getElementById('recentSurveys').textContent = recentCount;

            // Completion rate (surveys with all required fields)
            const completedSurveys = surveyData.filter(survey => {
                return survey.sleep_pre && survey.fatigue_pre && survey.concentration_pre;
            }).length;
            const completionRate = Math.round((completedSurveys / surveyData.length) * 100);
            document.getElementById('completionRate').textContent = completionRate + '%';

            // Timezone coverage
            const timezones = new Set();
            surveyData.forEach(survey => {
                if (survey.timezones_count) {
                    timezones.add(survey.timezones_count);
                }
            });
            document.getElementById('timezoneCount').textContent = timezones.size;
        }

        // Render dashboard sections
        function renderDashboard() {
            renderSymptomAnalysis();
            renderTravelPatterns();
            renderRecentSubmissions();
        }

        // Render symptom analysis
        function renderSymptomAnalysis() {
            const container = document.getElementById('symptomAnalysis');
            
            if (surveyData.length === 0) {
                container.innerHTML = '<div class="error">No survey data available</div>';
                return;
            }

            const symptoms = ['sleep', 'fatigue', 'concentration', 'irritability', 'gi'];
            let html = '<table class="data-table"><thead><tr><th>Symptom</th><th>Pre-Travel Avg</th><th>Post-Travel Avg</th><th>Change</th></tr></thead><tbody>';

            symptoms.forEach(symptom => {
                const preData = surveyData.filter(s => s[`${symptom}_pre`]).map(s => s[`${symptom}_pre`]);
                const postData = surveyData.filter(s => s[`${symptom}_post`]).map(s => s[`${symptom}_post`]);

                if (preData.length > 0 && postData.length > 0) {
                    const preAvg = (preData.reduce((a, b) => a + b, 0) / preData.length).toFixed(1);
                    const postAvg = (postData.reduce((a, b) => a + b, 0) / postData.length).toFixed(1);
                    const change = (postAvg - preAvg).toFixed(1);
                    const changeColor = change > 0 ? '#dc2626' : '#16a34a';
                    const changeSymbol = change > 0 ? '‚Üó' : '‚Üò';

                    html += `<tr>
                        <td><strong>${symptom.charAt(0).toUpperCase() + symptom.slice(1)}</strong></td>
                        <td>${preAvg}/5</td>
                        <td>${postAvg}/5</td>
                        <td style="color: ${changeColor}">${changeSymbol} ${change}</td>
                    </tr>`;
                }
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Render travel patterns
        function renderTravelPatterns() {
            const container = document.getElementById('travelPatterns');
            
            if (surveyData.length === 0) {
                container.innerHTML = '<div class="error">No travel data available</div>';
                return;
            }

            // Travel direction analysis
            const directions = {};
            const frequencies = {};
            
            surveyData.forEach(survey => {
                if (survey.travel_direction) {
                    directions[survey.travel_direction] = (directions[survey.travel_direction] || 0) + 1;
                }
                if (survey.travel_frequency) {
                    frequencies[survey.travel_frequency] = (frequencies[survey.travel_frequency] || 0) + 1;
                }
            });

            let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">';
            
            // Travel direction chart
            html += '<div><h3>Travel Direction</h3><table class="data-table"><thead><tr><th>Direction</th><th>Count</th><th>%</th></tr></thead><tbody>';
            Object.entries(directions).forEach(([direction, count]) => {
                const percentage = ((count / surveyData.length) * 100).toFixed(1);
                html += `<tr><td>${direction}</td><td>${count}</td><td>${percentage}%</td></tr>`;
            });
            html += '</tbody></table></div>';

            // Travel frequency chart
            html += '<div><h3>Travel Frequency</h3><table class="data-table"><thead><tr><th>Frequency</th><th>Count</th><th>%</th></tr></thead><tbody>';
            Object.entries(frequencies).forEach(([frequency, count]) => {
                const percentage = ((count / surveyData.length) * 100).toFixed(1);
                html += `<tr><td>${frequency}</td><td>${count}</td><td>${percentage}%</td></tr>`;
            });
            html += '</tbody></table></div>';

            html += '</div>';
            container.innerHTML = html;
        }

        // Render recent submissions
        function renderRecentSubmissions() {
            const container = document.getElementById('recentSubmissions');
            
            if (surveyData.length === 0) {
                container.innerHTML = '<div class="error">No submission data available</div>';
                return;
            }

            const recentSurveys = surveyData.slice(0, 10); // Show last 10
            let html = '<table class="data-table"><thead><tr><th>Date</th><th>Survey Code</th><th>Travel Direction</th><th>Timezones</th><th>Status</th></tr></thead><tbody>';

            recentSurveys.forEach(survey => {
                const date = survey.timestamp?.toDate?.() || new Date(survey.timestamp);
                const dateStr = date.toLocaleDateString();
                const isComplete = survey.sleep_pre && survey.fatigue_pre && survey.concentration_pre;
                const status = isComplete ? '‚úÖ Complete' : '‚ö†Ô∏è Partial';
                const statusColor = isComplete ? '#16a34a' : '#f59e0b';

                html += `<tr>
                    <td>${dateStr}</td>
                    <td><code>${survey.surveyCode || 'N/A'}</code></td>
                    <td>${survey.travel_direction || 'N/A'}</td>
                    <td>${survey.timezones_count || 'N/A'}</td>
                    <td style="color: ${statusColor}">${status}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Show loading state
        function showLoadingState() {
            document.getElementById('symptomAnalysis').innerHTML = '<div class="loading">Loading symptom data...</div>';
            document.getElementById('travelPatterns').innerHTML = '<div class="loading">Loading travel data...</div>';
            document.getElementById('recentSubmissions').innerHTML = '<div class="loading">Loading recent data...</div>';
        }

        // Show error message
        function showError(message) {
            const container = document.getElementById('symptomAnalysis');
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        // Refresh data function
        function refreshData() {
            console.log('üîÑ Refreshing dashboard data...');
            loadDashboardData();
        }

        // Auto-refresh every 5 minutes
        setInterval(() => {
            if (!isLoading) {
                console.log('üîÑ Auto-refreshing dashboard data...');
                loadDashboardData();
            }
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
