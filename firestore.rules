rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // TRIP COMPLETIONS COLLECTION (Main Research Data)
    // Phase 1: Write Source Authentication
    // ============================================================
    match /tripCompletions/{tripId} {
      
      // -------------------- READ ACCESS --------------------
      // Anyone can read for analytics dashboard
      allow read: if true;
      
      // -------------------- CREATE ACCESS --------------------
      // Check 1: Document ID matches tripId in data
      // Check 2: TripId matches supported formats (legacy + HMAC signature)
      // Check 3: Write includes metadata object
      // Check 4: Metadata has required fields
      // Check 5: Source is from approved list
      // Check 6: Timestamp field exists
      // Format: 8hex-AirportDir-YYMMDD-HHMM[-8hexSig]
      // Example: 2330B376-ISTE-251111-0052-55e927a7
      allow create: if 
        request.resource.data.tripId == tripId
        && (
          tripId.matches('^[A-F0-9]{8}-[A-Z]{4}-[0-9]{6}-[0-9]{4}$')
          || tripId.matches('^[A-F0-9]{8}-[A-Z]{4}-[0-9]{6}-[0-9]{4}-[a-f0-9]{8}$')
        )
        && request.resource.data.keys().hasAll(['_writeMetadata'])
        && request.resource.data._writeMetadata.keys().hasAll(['source', 'timestamp'])
        && request.resource.data._writeMetadata.source in ['ios_app', 'web_survey']
        && request.resource.data._writeMetadata.timestamp != null;
      
      // -------------------- UPDATE ACCESS --------------------
      // Allow updates ONLY if final document maintains metadata integrity
      allow update: if 
        // Final document (after merge) includes metadata
        request.resource.data._writeMetadata != null
        && request.resource.data._writeMetadata.source in ['ios_app', 'web_survey']
        && request.resource.data._writeMetadata.timestamp != null
        // Original metadata must still exist (cannot be deleted)
        && resource.data._writeMetadata != null
        
        // AND one of these conditions:
        && (
          // 1. Survey not yet completed (any updates allowed)
          resource.data.surveyCompleted != true
          
          // 2. Web survey retaking/editing (allows survey fields)
          || (
            request.resource.data.keys().hasAny(['_surveyMetadata', 'surveyCompleted'])
            && (
              request.resource.data._surveyMetadata.source == 'web_survey'
              || resource.data._surveyMetadata.source == 'web_survey'
            )
          )
          
          // 3. iOS app updating point completions during active trip
          || (request.resource.data._writeMetadata.source == 'ios_app' 
              && onlyUpdatingAllowedFields())
        );
      
      // -------------------- DELETE ACCESS --------------------
      // NEVER allow deletes (prevent data loss)
      allow delete: if false;
      
      // -------------------- HELPER FUNCTIONS --------------------
      function onlyUpdatingAllowedFields() {
        // During active trip, allow updating point completion fields
        // This lets app update as user stimulates points
        let allowedFields = [
          'pointsCompleted', 
          'point1Completed', 'point2Completed', 'point3Completed',
          'point4Completed', 'point5Completed', 'point6Completed',
          'point7Completed', 'point8Completed', 'point9Completed',
          'point10Completed', 'point11Completed', 'point12Completed',
          '_writeMetadata'  // Always allow updating metadata
        ];
        
        return request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(allowedFields);
      }
    }
    
    // ============================================================
    // AUDIT LOG COLLECTION
    // Immutable record of all tripCompletions operations
    // Written by Cloud Functions, readable by public for verification
    // Deployed: November 11, 2025
    // ============================================================
    match /auditLog/{entry} {
      allow read: if true;  // Public can verify
      allow write: if false;  // ONLY Cloud Functions can write
    }
    
    // ============================================================
    // SYSTEM COLLECTION
    // Internal state for Cloud Functions (notification tracking, etc.)
    // Deployed: November 25, 2025
    // ============================================================
    match /_system/{doc} {
      allow read: if true;  // Public can view system status
      allow write: if false;  // ONLY Cloud Functions can write
    }
    
    // ============================================================
    // SNAPSHOTS COLLECTION
    // Timestamped dataset snapshots for research publication
    // Not yet implemented
    // ============================================================
    match /_snapshots/{doc} {
      allow read: if true;  // Public can verify
      allow write: if false;  // ONLY Cloud Functions can write
    }
  }
}

