rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // TRIP COMPLETIONS COLLECTION (Main Research Data)
    // Phase 1: Write Source Authentication
    // ============================================================
    match /tripCompletions/{tripId} {
      
      // -------------------- READ ACCESS --------------------
      // Anyone can read for analytics dashboard
      allow read: if true;
      
      // -------------------- CREATE ACCESS --------------------
      // Allow creation ONLY if all conditions met:
      // NOTE: This blocks standalone surveys (no tripId) and "naked-survey-code" documents
      allow create: if 
        // 1. Document ID matches tripId in data (blocks standalone surveys)
        request.resource.data.tripId == tripId
        
        // 2. TripId matches supported formats (legacy + HMAC signature)
        // Legacy format: 7482966F-DXBE-251025-0946 (8hex-4hex-6digit-4digit)
        // HMAC format:   7482966F-DXBE-251025-0946-1fff947f (adds 8char signature)
        && (
          tripId.matches('^[A-F0-9]{8}-[A-F0-9]{4}-[0-9]{6}-[0-9]{4}$')
          || tripId.matches('^[A-F0-9]{8}-[A-F0-9]{4}-[0-9]{6}-[0-9]{4}-[a-f0-9]{8}$')
        )
        
        // 3. Write includes metadata object
        && request.resource.data.keys().hasAll(['_writeMetadata'])
        
        // 4. Metadata has required fields
        && request.resource.data._writeMetadata.keys().hasAll(['source', 'timestamp'])
        
        // 5. Source is from approved list
        && request.resource.data._writeMetadata.source in ['ios_app', 'web_survey']
        
        // 6. Timestamp is server timestamp
        && request.resource.data._writeMetadata.timestamp is timestamp;
      
      // -------------------- UPDATE ACCESS --------------------
      // Allow updates ONLY if final document maintains metadata integrity:
      allow update: if 
        // Final document (after merge) includes metadata
        request.resource.data._writeMetadata != null
        && request.resource.data._writeMetadata.source in ['ios_app', 'web_survey']
        && request.resource.data._writeMetadata.timestamp is timestamp
        // Original metadata must still exist (cannot be deleted)
        && resource.data._writeMetadata != null
        
        // AND one of these conditions:
        && (
          // 1. Survey not yet completed (any updates allowed)
          resource.data.surveyCompleted != true
          
          // 2. Web survey retaking/editing (allows survey fields)
          || (
            request.resource.data.keys().hasAny(['_surveyMetadata', 'surveyCompleted'])
            && (
              request.resource.data._surveyMetadata.source == 'web_survey'
              || resource.data._surveyMetadata.source == 'web_survey'
            )
          )
          
          // 3. iOS app updating point completions during active trip
          || (request.resource.data._writeMetadata.source == 'ios_app' 
              && onlyUpdatingAllowedFields())
        );
      
      // -------------------- DELETE ACCESS --------------------
      // NEVER allow deletes (prevent data loss)
      allow delete: if false;
      
      // -------------------- HELPER FUNCTIONS --------------------
      function onlyUpdatingAllowedFields() {
        // During active trip, allow updating point completion fields
        // This lets app update as user stimulates points
        let allowedFields = [
          'pointsCompleted', 
          'point1Completed', 'point2Completed', 'point3Completed',
          'point4Completed', 'point5Completed', 'point6Completed',
          'point7Completed', 'point8Completed', 'point9Completed',
          'point10Completed', 'point11Completed', 'point12Completed',
          '_writeMetadata'  // Always allow updating metadata
        ];
        
        return request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(allowedFields);
      }
    }
    
    // ============================================================
    // AUDIT LOG COLLECTION (Phase 2 - Not Yet Implemented)
    // ============================================================
    match /auditLog/{entry} {
      allow read: if true;  // Public can verify
      allow write: if false;  // ONLY Cloud Functions can write
    }
    
    // ============================================================
    // SNAPSHOTS COLLECTION (Phase 3 - Not Yet Implemented)
    // ============================================================
    match /_snapshots/{doc} {
      allow read: if true;  // Public can verify
      allow write: if false;  // ONLY Cloud Functions can write
    }
  }
}

